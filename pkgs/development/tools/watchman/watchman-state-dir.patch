commit 927e99b792b71b28b7915d72d615186c7ac0abb7
Author: Matthew Glazar <strager.nds@gmail.com>
Date:   Sun Mar 10 15:28:13 2019 -0700

    @untested Allow configuring WATCHMAN_STATE_DIR at build time

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 1f94d822..7c85b54f 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -101,6 +101,15 @@ set(
   WATCHMAN_CONFIG_FILE "${WATCHMAN_DEFAULT_CONFIG_FILE}"
   CACHE STRING "Run-time path of the global watchman.json configuration file")

+if(CMAKE_SYSTEM_NAME STREQUAL "Windows")
+  set(WATCHMAN_DEFAULT_STATE_DIR)
+else()
+  set(WATCHMAN_DEFAULT_STATE_DIR "${CMAKE_INSTALL_PREFIX}/var/run/watchman")
+endif()
+set(
+  WATCHMAN_STATE_DIR "${WATCHMAN_DEFAULT_STATE_DIR}"
+  CACHE STRING "Run-time path of the persistent state directory")
+
 # configure_file wants us to define a separate file.  I'd rather not
 # have boilerplate for the same thing in two difference files, so we
 # roll the checks in together with writing out the features to config.h
@@ -111,8 +120,7 @@ endfunction()

 file(WRITE "${CMAKE_CURRENT_BINARY_DIR}/config.h.new" "#pragma once\n")

-if(NOT CMAKE_SYSTEM_NAME STREQUAL "Windows")
-  set(WATCHMAN_STATE_DIR "${CMAKE_INSTALL_PREFIX}/var/run/watchman")
+if(WATCHMAN_STATE_DIR)
   install(DIRECTORY DESTINATION ${WATCHMAN_STATE_DIR} DIRECTORY_PERMISSIONS
     OWNER_READ OWNER_WRITE OWNER_EXECUTE GROUP_READ GROUP_WRITE
     GROUP_EXECUTE WORLD_READ WORLD_WRITE WORLD_EXECUTE SETGID)
@@ -122,7 +130,7 @@ config_h("// Generated by cmake")
 if(WATCHMAN_CONFIG_FILE)
   config_h("#define WATCHMAN_CONFIG_FILE \"${WATCHMAN_CONFIG_FILE}\"")
 endif()
-if(NOT CMAKE_SYSTEM_NAME STREQUAL "Windows")
+if(WATCHMAN_STATE_DIR)
   config_h("#define WATCHMAN_STATE_DIR \"${WATCHMAN_STATE_DIR}\"")
 endif()
 config_h("#define PACKAGE_VERSION \"${PACKAGE_VERSION}\"")
diff --git a/website/_docs/cli-options.markdown b/website/_docs/cli-options.markdown
index ae1efa53..6746cf18 100644
--- a/website/_docs/cli-options.markdown
+++ b/website/_docs/cli-options.markdown
@@ -37,8 +37,8 @@ Watchman tracks its persistent state in a location that we refer to as the
 *Since 3.1.*

 The `STATEDIR` defaulted to `<PREFIX>/var/run/watchman`.  You can change this
-default when you build watchman by using the configure option
-`--enable-statedir`.
+default when you build watchman by using the CMake option
+`-DWATCHMAN_STATE_DIR`.

 Earlier versions of Watchman didn't have a default statedir and would instead
 use the `<TMPDIR>` for this state.  We switched away from that because some
@@ -48,11 +48,11 @@ clients to locate the Watchman service.
 *Since 3.8.*

 The `STATEDIR` defaults to `<PREFIX>/var/run/watchman/<USER>-state`.  You can
-change this default when you build watchman by using the configure option
-`--enable-statedir`; the configure option replaces the
+change this default when you build watchman by using the CMake option
+`-DWATCHMAN_STATE_DIR`; the configure option replaces the
 `<PREFIX>/var/run/watchman` portion of this string.  If you specify
-`--disable-statedir` then that portion of the string will be computed from the
-`<TMPDIR>` location.
+`-DWATCHMAN_STATE_DIR=` (empty value) then that portion of the string will be
+computed from the `<TMPDIR>` location.

 Watchman will create the `<USER>-state` portion if it does not exist, and will
 perform some permission and ownership checks to reduce the risk of untrusted
